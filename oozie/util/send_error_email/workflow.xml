<?xml version="1.0" encoding="UTF-8"?>
<workflow-app xmlns="uri:oozie:workflow:0.4"
    name="send-error-email-wf">

    <!--
        This subworflow is a simple wrapper over the oozie email action
          allowing to provide default values for most of the needed fields.
    -->

    <parameters>

        <property>
            <name>parent_id</name>
            <!-- Provide a default value for the job not to fail if not set-->
            <value>UNSET</value>
            <description>The id of the parent workflow in error.</description>
        </property>

        <property>
            <name>hue_url</name>
            <!-- Provide a default value for the job not to fail if not set-->
            <value>https://hue.wikimedia.org/oozie/list_oozie_workflows</value>
            <description>The id of the parent workflow in error (default to workflow list url).</description>
        </property>

        <property>
            <name>parent_name</name>
            <!-- Provide a default value for the job not to fail if not set-->
            <value>UNSET</value>
            <description>The name of the parent workflow in error.</description>
        </property>

        <property>
            <name>parent_failed_action</name>
            <!-- Provide a default value for the job not to fail if not set-->
            <value>UNSET</value>
            <description>The name of the parent action that failed.</description>
        </property>

        <property>
            <name>parent_error_code</name>
            <!-- Provide a default value for the job not to fail if not set-->
            <value>UNSET</value>
            <description>The error code generated by the parent action that failed.</description>
        </property>

        <property>
            <name>parent_error_message</name>
            <!-- Provide a default value for the job not to fail if not set-->
            <value>UNSET</value>
            <description>The error message generated by the parent action that failed.</description>
        </property>

        <property>
            <name>to</name>
            <value>analytics-alerts@wikimedia.org</value>
            <description>
                The comma-separated list of email recipients
            </description>
        </property>

        <property>
            <name>subject</name>
            <value>Fatal Error - Oozie Job ${parent_name}</value>
            <description>
                The subject of the email
            </description>
        </property>

        <property>
            <name>body</name>
            <value>Error details:
    - Job id: ${parent_id}
    - Failing action: ${parent_failed_action}
    - Error code: ${parent_error_code}
    - Error message: ${parent_error_message}
    - Hue link: ${hue_url}

Please have a look and take necessary action !
Thanks :)
-- Oozie
            </value>
            <description>
                The body of the email
            </description>
        </property>

        <property>
            <name>attachments</name>
            <value>UNSET</value>
            <description>
                A comma separated list of file paths to attach
            </description>
        </property>

    </parameters>

    <start to="attach_or_not"/>

    <decision name="attach_or_not">
        <switch>
            <case to="send_email">
                ${attachments == "UNSET"}
            </case>
            <default to="send_email_with_attachments"/>
        </switch>
    </decision>

    <action name="send_email">
        <email xmlns="uri:oozie:email-action:0.1">
            <to>${to}</to>
            <subject>${subject}</subject>
            <body>${body}</body>
        </email>
        <ok to="end"/>
        <error to="kill"/>
    </action>

    <action name="send_email_with_attachments">
        <email xmlns="uri:oozie:email-action:0.2">
            <to>${to}</to>
            <subject>${subject}</subject>
            <body>${body}</body>
            <attachment>${attachments}</attachment>
        </email>
        <ok to="end"/>
        <error to="kill"/>
    </action>

    <kill name="kill">
        <message>send_error_email action failed, error message[${wf:errorMessage(wf:lastErrorNode())}]</message>
    </kill>
    <end name="end"/>
</workflow-app>
